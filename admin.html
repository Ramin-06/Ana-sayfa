<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    doc,
    deleteDoc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCSaiU9DguIk47O8LPZ_Oa6StJgHbPqZ6I",
    authDomain: "perfume-8b7f7.firebaseapp.com",
    projectId: "perfume-8b7f7",
    storageBucket: "perfume-8b7f7.appspot.com",
    messagingSenderId: "899731999798",
    appId: "1:899731999798:web:750af78287f56d15d41c97"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM elementləri
  const form = document.getElementById("productForm");
  const tableBody = document.querySelector("#productTable tbody");

  const mlButtons = document.querySelectorAll(".ml-button");
  const priceInput = document.getElementById("productPrice");

  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEdit");
  const formTitle = document.getElementById("formTitle");
  const productCodeInput = document.getElementById("productCode");

  let selectedMl = "30";
  let selectedPrice = "10";
  let editDocId = null;

  // Quill editor
  const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Məhsul açıqlaması',
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline'],
        [{ 'header': 1 }, { 'header': 2 }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        [{ 'color': [] }, { 'background': [] }],
        ['clean']
      ]
    }
  });

  mlButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      mlButtons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      selectedMl = btn.getAttribute("data-ml");
      selectedPrice = btn.getAttribute("data-price");

      priceInput.value = selectedPrice;
    });
  });

  async function renderProducts() {
    tableBody.innerHTML = "";
    try {
      const querySnapshot = await getDocs(collection(db, "products"));

      if (querySnapshot.empty) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5" style="text-align:center; font-style: italic;">Hələ məhsul əlavə edilməyib...</td>`;
        tableBody.appendChild(row);
        return;
      }

      querySnapshot.forEach(docSnap => {
        const product = docSnap.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${product.code}</td>
          <td>${product.name}</td>
          <td>${product.ml}</td>
          <td>${product.price}</td>
          <td>
            <button class="edit-btn" data-id="${docSnap.id}">Düzəlt</button>
            <button class="delete-btn" data-id="${docSnap.id}">Sil</button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          editProduct(btn.getAttribute("data-id"));
        });
      });
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          deleteProduct(btn.getAttribute("data-id"));
        });
      });
    } catch(e) {
      alert("Məhsullar yüklənərkən xəta: " + e.message);
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const code = productCodeInput.value.trim();
    const name = document.getElementById("productName").value.trim();
    const description = quill.root.innerHTML.trim();
    const price = priceInput.value.trim();

    if (!code || !name || !price) {
      alert("Zəruri olan yerləri doldurun.");
      return;
    }

    try {
      if (!editDocId) {
        await addDoc(collection(db, "products"), {
          code, name, price, description, ml: selectedMl
        });
        alert("Məhsul əlavə olundu!");
      } else {
        const docRef = doc(db, "products", editDocId);
        await updateDoc(docRef, {
          code, name, price, description, ml: selectedMl
        });
        alert("Məhsul yeniləndi!");
      }
      resetForm();
      renderProducts();
    } catch (error) {
      alert("Xəta baş verdi: " + error.message);
    }
  });

  async function deleteProduct(id) {
    if (confirm("Məhsul silinəcək! Razısınız?")) {
      try {
        await deleteDoc(doc(db, "products", id));
        if (editDocId === id) resetForm();
        renderProducts();
      } catch (error) {
        alert("Silərkən xəta baş verdi.");
      }
    }
  }

  async function editProduct(id) {
    try {
      const docRef = doc(db, "products", id);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const product = docSnap.data();

        productCodeInput.value = product.code;
        document.getElementById("productName").value = product.name;
        quill.root.innerHTML = product.description;

        selectedMl = product.ml;
        selectedPrice = product.price;
        priceInput.value = selectedPrice;

        mlButtons.forEach(btn => {
          btn.classList.toggle("selected", btn.getAttribute("data-ml") === selectedMl);
        });

        productCodeInput.setAttribute("readonly", "readonly");

        submitBtn.textContent = "Düzəlt";
        cancelEditBtn.style.display = "inline-block";
        formTitle.textContent = "Məhsulu düzəlt";

        editDocId = id;
      } else {
        alert("Məhsul tapılmadı!");
      }
    } catch (error) {
      alert("Düzəltmə zamanı xəta baş verdi.");
    }
  }

  function resetForm() {
    form.reset();

    selectedMl = "30";
    selectedPrice = "10";
    priceInput.value = selectedPrice;

    mlButtons.forEach(b => b.classList.remove("selected"));
    mlButtons[0].classList.add("selected");

    productCodeInput.removeAttribute("readonly");
    submitBtn.textContent = "Əlavə et";
    cancelEditBtn.style.display = "none";
    formTitle.textContent = "Yeni məhsul əlavə et";

    quill.setContents([]);

    editDocId = null;
  }

  cancelEditBtn.addEventListener("click", () => {
    resetForm();
  });

  window.onload = () => {
    renderProducts();
    priceInput.value = selectedPrice;
  };
</script>
